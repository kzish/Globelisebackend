variables:
  CARGO_HOME: "${CI_PROJECT_DIR}/.cargo"

default:
  image: rust:latest
  cache:
    paths:
      # Paths required for all builds and tests
      - .cargo/registry/index/
      - .cargo/registry/cache/
      - .cargo/git/db/
      - target/
      # Paths required only for tests
      - .cargo/bin/
      - .cargo/.crates.toml
      - .cargo/.crates2.json
  before_script:
    - rustup component add rustfmt

install-tools:
  stage: install-test-tools
  script:
    - cargo install cargo-nextest
    - cargo install cargo-tarpaulin
    - cargo install cargo-deny

test:
  extends: default
  stage: test
  cache:
    policy: pull
  script:
    - cargo nextest run --no-fail-fast

coverage:
  stage: test
  cache:
    paths:
      - .cargo/registry/index/
      - .cargo/registry/cache/
      - .cargo/git/db/
      - target-coverage/
      - .cargo/bin/
      - .cargo/.crates.toml
      - .cargo/.crates2.json
  script:
    - cargo tarpaulin --ignore-tests --skip-clean --target-dir target-coverage/
  coverage: '/^\d+.\d+% coverage/'

lint:
  extends: default
  stage: test
  cache:
    policy: pull
  script:
    - rustup component add clippy
    - cargo clippy -- -D warnings
    
format:
  extends: default
  stage: test
  cache:
    policy: pull
  script:
    - cargo fmt --check

audit:
  extends: default
  stage: test
  cache:
    policy: pull
  script:
    - cargo deny check
